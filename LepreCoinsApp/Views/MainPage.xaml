<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LepreCoinsApp.ViewModels"
             xmlns:models="clr-namespace:Interfaces.DTO;assembly=Interfaces"
             xmlns:converters="clr-namespace:LepreCoinsApp.Converters"
             x:Class="LepreCoinsApp.Views.MainPage"
             BackgroundColor="#0F1419">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:TransactionTypeColorConverter x:Key="TransactionTypeColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*">
        <CollectionView ItemsSource="{Binding Transactions}" SelectionMode="None">
            <CollectionView.Header>
                <VerticalStackLayout Spacing="20" Padding="20">
                    <Label Text="Мои Финансы" FontSize="28" FontAttributes="Bold" TextColor="White"/>

                    <Frame BackgroundColor="#1a1d21" BorderColor="#333" CornerRadius="15" Padding="20">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="ОБЩИЙ БАЛАНС" FontSize="12" TextColor="#777" CharacterSpacing="2"/>
                            <Label Text="{Binding TotalBalance, StringFormat='{0:N0} ₽'}" 
                                   FontSize="36" FontAttributes="Bold" TextColor="#2ecc71"/>
                        </VerticalStackLayout>
                    </Frame>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <Button Grid.Column="0" Text="+ Доход" Command="{Binding AddIncomeCommand}" 
                                BackgroundColor="#2ecc71" HeightRequest="50" CornerRadius="10"/>
                        <Button Grid.Column="1" Text="- Расход" Command="{Binding AddExpenseCommand}" 
                                BackgroundColor="#e74c3c" HeightRequest="50" CornerRadius="10"/>
                    </Grid>

                    <Label Text="ИСТОРИЯ ОПЕРАЦИЙ" FontSize="12" TextColor="#777" Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </CollectionView.Header>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TransactionDto">
                    <Grid Padding="20,5">
                        <Frame BackgroundColor="#1a1d21" BorderColor="#333" Padding="15" CornerRadius="12">
                            <Grid ColumnDefinitions="*, Auto, Auto" ColumnSpacing="10">

                                <VerticalStackLayout Grid.Column="0" VerticalOptions="Center">
                                    <Label Text="{Binding Description}" FontSize="16" FontAttributes="Bold" TextColor="White"/>
                                    <Label Text="{Binding Date, StringFormat='{0:dd.MM.yyyy}'}" FontSize="12" TextColor="#555"/>
                                </VerticalStackLayout>

                                <Label Grid.Column="1" VerticalOptions="Center" Margin="0,0,10,0"
                                       Text="{Binding Amount, StringFormat='{0:N0} ₽'}" 
                                       TextColor="{Binding Type, Converter={StaticResource TransactionTypeColorConverter}}"
                                       FontAttributes="Bold" FontSize="16"/>

                                <HorizontalStackLayout Grid.Column="2" Spacing="5">
                                    <ImageButton Source="edit_icon.png" 
                                                 Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=EditTransactionCommand}"
                                                 CommandParameter="{Binding .}"
                                                 HeightRequest="35" WidthRequest="35"
                                                 BackgroundColor="#2c313a" CornerRadius="5" Padding="8"/>

                                    <ImageButton Source="delete_icon.png" 
                                                 Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=DeleteTransactionCommand}"
                                                 CommandParameter="{Binding .}"
                                                 HeightRequest="35" WidthRequest="35"
                                                 BackgroundColor="#3a2c2c" CornerRadius="5" Padding="8"/>
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.Footer>
                <BoxView HeightRequest="20" Color="Transparent"/>
            </CollectionView.Footer>
        </CollectionView>

        <Grid IsVisible="{Binding IsTransactionPopupVisible}" BackgroundColor="#CC000000">
            <Frame BackgroundColor="#2a2d31" CornerRadius="20" Margin="30" VerticalOptions="Center" BorderColor="#444">
                <VerticalStackLayout Spacing="15">
                    <Label Text="{Binding TransactionPopupTitle}" FontSize="22" FontAttributes="Bold" HorizontalOptions="Center" TextColor="White"/>

                    <Entry Placeholder="Сумма" Text="{Binding TransactionAmountText}" Keyboard="Numeric" 
                           BackgroundColor="#1e1f22" TextColor="White" HeightRequest="50"/>

                    <Entry Placeholder="Описание" Text="{Binding TransactionDescription}" 
                           BackgroundColor="#1e1f22" TextColor="White" HeightRequest="50"/>

                    <Picker Title="Кошелек" ItemsSource="{Binding Wallets}" ItemDisplayBinding="{Binding Name}" 
                            SelectedItem="{Binding SelectedWallet}" TextColor="White" TitleColor="#777"/>

                    <Picker Title="Категория" ItemsSource="{Binding Categories}" ItemDisplayBinding="{Binding Title}" 
                            SelectedItem="{Binding SelectedCategory}" TextColor="White" TitleColor="#777"/>

                    <Label Text="{Binding TransactionFormError}" TextColor="#e74c3c" IsVisible="{Binding HasTransactionFormError}" HorizontalOptions="Center"/>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <Button Grid.Column="0" Text="Отмена" Command="{Binding CancelTransactionCommand}" BackgroundColor="#444"/>
                        <Button Grid.Column="1" Text="Готово" Command="{Binding SaveTransactionCommand}" BackgroundColor="#2ecc71"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <ActivityIndicator IsRunning="{Binding IsBusy}" Color="#2ecc71" VerticalOptions="Center" HorizontalOptions="Center"/>
    </Grid>
</ContentPage>