<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LepreCoinsApp.Views.BudgetPage"
             Title="Управление Бюджетом"
             BackgroundColor="#0F1419">

    <ContentPage.Content>
        <Grid RowDefinitions="Auto,*" Padding="20">

            <!-- Верхняя часть - Статистика -->
            <StackLayout Grid.Row="0" Spacing="15">
                <Label Text="Мой Бюджет" FontSize="28" FontAttributes="Bold" TextColor="#FFFFFF"/>
                <Label Text="Управляйте своим месячным бюджетом" FontSize="14" TextColor="#999"/>

                <!-- Карточка статистики -->
                <Frame BorderColor="#333" CornerRadius="12" Padding="20" BackgroundColor="#1a1f26" HasShadow="False">
                    <VerticalStackLayout Spacing="12">
                        <!-- 3 колонки статистики -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                            <!-- Лимит -->
                            <VerticalStackLayout Grid.Column="0" Spacing="5">
                                <Label Text="Лимит" FontSize="11" TextColor="#999"/>
                                <Label FontSize="18" FontAttributes="Bold" TextColor="#3498db">
                                    <Label.Text>
                                        <MultiBinding StringFormat="₽{0:F0}">
                                            <Binding Path="BudgetLimit"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </VerticalStackLayout>

                            <!-- Потрачено -->
                            <VerticalStackLayout Grid.Column="1" Spacing="5">
                                <Label Text="Потрачено" FontSize="11" TextColor="#999"/>
                                <Label FontSize="18" FontAttributes="Bold" TextColor="#e74c3c">
                                    <Label.Text>
                                        <MultiBinding StringFormat="₽{0:F0}">
                                            <Binding Path="SpentAmount"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </VerticalStackLayout>

                            <!-- Остаток -->
                            <VerticalStackLayout Grid.Column="2" Spacing="5">
                                <Label Text="Остаток" FontSize="11" TextColor="#999"/>
                                <Label FontSize="18" FontAttributes="Bold" TextColor="#2ecc71">
                                    <Label.Text>
                                        <MultiBinding StringFormat="₽{0:F0}">
                                            <Binding Path="BudgetLimit"/>
                                            <Binding Path="SpentAmount"/>
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Прогресс бар -->
                        <ProgressBar HeightRequest="8" BackgroundColor="#333" ProgressColor="#e74c3c"/>
                        <Label FontSize="12" TextColor="#999">
                            <Label.Text>
                                <MultiBinding StringFormat="Использовано: {0:F1}%">
                                    <Binding Path="PercentageUsed"/>
                                </MultiBinding>
                            </Label.Text>
                        </Label>

                        <!-- Кнопка редактирования -->
                        <Button Text="✏️ Изменить план на месяц"
                                BackgroundColor="#3498db"
                                TextColor="#FFFFFF"
                                FontAttributes="Bold"
                                FontSize="14"
                                Padding="20,12"
                                CornerRadius="8"
                                Command="{Binding OpenEditPopupCommand}"/>
                    </VerticalStackLayout>
                </Frame>
            </StackLayout>

            <!-- Нижняя часть - Список категорий -->
            <CollectionView Grid.Row="1" 
                           ItemsSource="{Binding BudgetAnalysis.Categories}"
                           SelectionMode="None"
                           Margin="0,20,0,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame BorderColor="#333" CornerRadius="10" Padding="15" Margin="0,8" BackgroundColor="#1a1f26" HasShadow="False">
                            <VerticalStackLayout Spacing="8">
                                <!-- Название и процент -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Grid.Column="0" 
                                           Text="{Binding Category}" 
                                           FontSize="13" 
                                           FontAttributes="Bold"
                                           TextColor="#FFFFFF"
                                           VerticalOptions="Center"/>
                                    <Label Grid.Column="1" 
                                           FontSize="12" 
                                           FontAttributes="Bold"
                                           TextColor="#e74c3c">
                                    </Label>
                                </Grid>

                                <!-- Потраченная сумма и лимит -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Label Grid.Column="0" 
                                           FontSize="11" 
                                           TextColor="#999">
                                        <Label.Text>
                                            <MultiBinding StringFormat="Потрачено: ₽{0:F0}">
                                                <Binding Path="Spent"/>
                                            </MultiBinding>
                                        </Label.Text>
                                    </Label>
                                    <Label Grid.Column="1" 
                                           FontSize="11" 
                                           TextColor="#999">
                                        <Label.Text>
                                            <MultiBinding StringFormat="Лимит: ₽{0:F0}">
                                                <Binding Path="Limit"/>
                                            </MultiBinding>
                                        </Label.Text>
                                    </Label>
                                </Grid>

                                <!-- Прогресс бар -->
                                <ProgressBar HeightRequest="6" BackgroundColor="#333" ProgressColor="#3498db"/>
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- МОДАЛЬНОЕ ОКНО РЕДАКТИРОВАНИЯ (Popup) -->
            <Grid IsVisible="{Binding IsEditPopupVisible}" 
                  BackgroundColor="#00000080"
                  ZIndex="1000">
                <Frame CornerRadius="15" 
                       Padding="20" 
                       BackgroundColor="#1a1f26" 
                       Margin="30"
                       VerticalOptions="Center"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="15">
                        <!-- Заголовок -->
                        <Label Text="Изменить план на месяц" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="#FFFFFF"/>

                        <!-- Поле лимита -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Лимит бюджета (₽)" 
                                   FontSize="12" 
                                   TextColor="#999"
                                   FontAttributes="Bold"/>
                            <Entry x:Name="BudgetLimitEntry"
                                   Text="{Binding BudgetLimitText}"
                                   Placeholder="Введите сумму"
                                   Keyboard="Numeric"
                                   BackgroundColor="#0F1419"
                                   TextColor="#FFFFFF"
                                   PlaceholderColor="#666"
                                   FontSize="14"
                                   />
                        </VerticalStackLayout>

                        <!-- Дата начала -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Начало периода" 
                                   FontSize="12" 
                                   TextColor="#999"
                                   FontAttributes="Bold"/>
                            <DatePicker Date="{Binding PeriodStart}"
                                      BackgroundColor="#0F1419"
                                      TextColor="#FFFFFF"
                                      FontSize="14"/>
                        </VerticalStackLayout>

                        <!-- Дата конца -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="Конец периода" 
                                   FontSize="12" 
                                   TextColor="#999"
                                   FontAttributes="Bold"/>
                            <DatePicker Date="{Binding PeriodEnd}"
                                      BackgroundColor="#0F1419"
                                      TextColor="#FFFFFF"
                                      FontSize="14"/>
                        </VerticalStackLayout>

                        <!-- Сообщение об ошибке -->
                        <Label Text="{Binding EditError}" 
                               TextColor="#e74c3c"
                               FontSize="12"
                               FontAttributes="Bold"
                               LineBreakMode="WordWrap"/>

                        <!-- Кнопки действий -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                            <Button Grid.Column="0"
                                   Text="Отмена"
                                   BackgroundColor="#555"
                                   TextColor="#FFFFFF"
                                   FontAttributes="Bold"
                                   FontSize="13"
                                   Padding="15,12"
                                   CornerRadius="6"
                                   Command="{Binding CloseEditPopupCommand}"/>
                            <Button Grid.Column="1"
                                   Text="Сохранить"
                                   BackgroundColor="#3498db"
                                   TextColor="#FFFFFF"
                                   FontAttributes="Bold"
                                   FontSize="13"
                                   Padding="15,12"
                                   CornerRadius="6"
                                   Command="{Binding SaveBudgetCommand}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
            </Grid>

        </Grid>
    </ContentPage.Content>

</ContentPage>
